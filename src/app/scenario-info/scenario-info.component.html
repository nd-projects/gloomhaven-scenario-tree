<div id="scenario-info-component">
    <form>
        <mat-form-field *ngIf="scenarios">
            <input matInput placeholder="Select A Scenario" aria-label="selected scenario" [matAutocomplete]="auto"
                [formControl]="scenarioCtrl">
            <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayFn"
                (optionSelected)="handleScenarioSelect($event)">
                <mat-option *ngFor="let scenario of filteredScenarios | async" [value]="scenario">
                    <span *ngIf="showScenarioName(scenario)">{{scenario.data.name}}</span>
                    <span *ngIf="!showScenarioName(scenario)"># {{scenario.data.id}}</span> |
                    <small>Status: {{scenario.data.status}}</small>
                </mat-option>
            </mat-autocomplete>
            <mat-icon matSuffix (click)="clearScenario()">clear</mat-icon>
        </mat-form-field>
    </form>
    <div class="scenario-info-content">
        <div *ngIf="selectedScenario">
            <div *ngIf="scenario.status === 'locked' || scenario.status === 'hidden'; else isUnlockedBlock"
                class="scenario-header">
                <h2># {{selectedScenario.id}}</h2>
                <button *ngIf="scenario.status === 'locked'" mat-raised-button color="primary" type="button"
                    (click)="unlockScenario()">
                    <mat-icon>lock_open</mat-icon>
                    Unlock
                </button>
                <button *ngIf="scenario.status === 'hidden'" mat-raised-button color="primary" type="button"
                    (click)="unhideScenario()">
                    <mat-icon>visibility</mat-icon>
                    Show
                </button>
            </div>
            <ng-template #isUnlockedBlock>
                <div class="scenario-header">
                    <h2>{{selectedScenario.name}}</h2>
                    <button mat-stroked-button (click)="lockScenario()" *ngIf="isSideScenario()" type="button"
                        [disabled]="scenario.status === 'attempted' || scenario.status === 'complete'">
                        <mat-icon>lock</mat-icon>
                        Lock Scenario
                    </button>
                    <button mat-stroked-button (click)="hideScenario()" *ngIf="!isSideScenario()" type="button"
                        [disabled]="scenario.status === 'attempted' || scenario.status === 'complete'">
                        <mat-icon>visibility_off</mat-icon>
                        Hide Scenario
                    </button>
                </div>
                <form (ngSubmit)="saveScenarioData(true)" #scenarioForm="ngForm">
                    <div class="section-header">
                        <mat-icon>image</mat-icon>
                        <h3>Scenario Images</h3>
                    </div>
                    <mat-expansion-panel *ngIf="selectedScenario.pages?.length" class="scenario-pages-panel">
                        <mat-expansion-panel-header>
                            <mat-panel-title>
                                Click Thumbnail to View Full Page
                            </mat-panel-title>
                        </mat-expansion-panel-header>
                        <div class="scenario-pages-container">
                            <img *ngFor="let page of selectedScenario.pages" [src]="getImageUrl(page)"
                                (click)="showScenarioModal(selectedScenario.pages.map(getImageUrl, this))"
                                class="scenario-page-img" matTooltip="Click to enlarge">
                        </div>
                    </mat-expansion-panel>
                    <mat-divider class="section-divider"></mat-divider>
                    
                    <div class="section-header">
                        <mat-icon>stars</mat-icon>
                        <h3>Scenario Status</h3>
                    </div>
                    <mat-button-toggle-group #group="matButtonToggleGroup" [ngModel]="scenario.status"
                        (ngModelChange)="handleStatusChange($event)" name="status">
                        <mat-button-toggle value="incomplete">
                            Incomplete
                        </mat-button-toggle>
                        <mat-button-toggle value="attempted">
                            Attempted
                        </mat-button-toggle>
                        <mat-button-toggle value="complete">
                            Complete
                        </mat-button-toggle>
                    </mat-button-toggle-group>
                    <mat-divider class="section-divider"></mat-divider>

                    <div *ngIf="treasureArray.length" class="treasure-section">
                        <div class="section-header">
                            <mat-icon>inventory_2</mat-icon>
                            <h3>Treasure</h3>
                        </div>
                        <mat-list>
                            <mat-list-item *ngFor="let treasure of treasureArray" class="treasure-item">
                                <div class="treasure-row">
                                    <mat-slide-toggle [checked]="treasure.looted"
                                        (change)="handleTreasureChange($event, treasure.id)"
                                        matTooltip="Mark as looted">
                                        <span class="treasure-id">{{ treasure.id }}</span>
                                    </mat-slide-toggle>
                                    <div class="treasure-description" [class.hidden-treasure]="!treasure.looted">
                                        <span *ngIf="treasure.looted">{{ treasure.description }}</span>
                                        <span *ngIf="!treasure.looted" class="placeholder-text">
                                            <mat-icon class="lock-icon">lock</mat-icon>
                                            Treasure details hidden
                                        </span>
                                    </div>
                                </div>
                            </mat-list-item>
                        </mat-list>
                    </div>

                    <mat-divider class="section-divider"></mat-divider>

                    <div class="notes-section">
                        <div class="section-header">
                            <mat-icon>note_alt</mat-icon>
                            <h3>Scenario Notes</h3>
                        </div>
                        <mat-form-field appearance="outline">
                            <mat-label>Notes</mat-label>
                            <textarea matInput placeholder="Add details about this scenario (e.g. key items found, special rules)..." 
                                [(ngModel)]="scenario.notes" name="notes" (ngModelChange)="onNotesChange()"></textarea>
                        </mat-form-field>
                    </div>
                </form>
            </ng-template>
        </div>
        <div *ngIf="!selectedScenario">
            <p>Select A Scenario To View Details...</p>
        </div>
    </div>
</div>